Module API
==========

This file contains info needed to write a module.


Variables
---------
All bash variables in the module that are global MUST follow the format
module_modulename_variablename to prevent overwriting other modules, or
global bot variables. FAQ module may use: module_faq_last_query for example
as a variable.

Variables that are local to the function (using the local directive) may have
other names. Don't forget variables created in for loops and such
(for foo in bar bash; do echo $foo; done the $foo variable is global here,
 do local foo on the line before it)


Functions and hooks
-------------------
Hooks are functions with special names, as listed below in the section "The hooks".

Each function or hook should start with the module_ followed by the module name.
So if the module is faq.sh the modules should start with module_faq_ like module_faq_INIT.

All bash functions in the module MUST follow the format
module_modulename_functionname to prevent overwriting other modules, or
global bot functions.

If not mentioned otherwise the hook is optional.
Functions marked with TODO may change, get renamed or removed and may not work
even in current code.


The hooks
---------
module_modulename_INIT (REQUIRED)
	Called directly after loading the module.
	No parameters.
	If return code isn't 0 the module is considered as failed to load.
	The module should clean up after itself in this case before it returns
	from INIT.
	On STDOUT should be returned a space separated list of functions the
	module implements. FAQ would return "before_connect on_PRIVMSG"


module_modulename_FINALISE
	Called directly before the bot quits. The bot has already closed
	the connection to the IRC server at this point. This is for saving
	stuff.
	No parameters.
	Return code isn't checked.


module_modulename_before_connect
	Called before the bot connected.
	No parameters
	Return code not checked.
	Note: This is useful for stuff that needs to echo log messages
	      as that can't be done in modulename_INIT.


module_modulename_on_connect
	Called for each line that the bot
	receives from the server during connecting.
	$1 = raw line.
	Return code not checked.


module_modulename_after_connect
	Called after the bot connected.
	No parameters
	Return code not checked.


module_modulename_on_PRIVMSG
	Called when bot gets a PRIVMSG
	$1 = from who (n!u@h)
	$2 = to who (channel or botnick)
	$3 = the message
	Return code:
		0 = pass it on to next module
		1 = I have taken care of this, and don't
		    consult other modules about this.


module_modulename_on_NOTICE
	Called when bot gets a NOTICE
	$1 = from who (n!u@h)
	$2 = to who (channel or botnick)
	$3 = the message
	Return code:
		0 = pass it on to next module
		1 = I have taken care of this, and don't
		    consult other modules about this.


module_modulename_on_NICK
	# :AnMaster!AnMaster@staff.kuonet-ng.org NICK AnMaster_test
	Called when someone changes nick in a channel the bot is in
	$1 = from who (n!u@h)
	$2 = new nick
	Return code not checked.
		Reason: A module with a list of users could get desynced if it didn't
		get the nick change.


module_modulename_on_JOIN
	# :AnMaster!AnMaster@staff.kuonet-ng.org JOIN :#test
	Called when someone joins a channel the bot is in
	$1 = who did it (n!u@h)
	$2 = what channel
	Return code not checked.
		Reason: A module with a list of users could get desynced if it didn't
		get the join.


module_modulename_on_PART
	# :AnMaster!AnMaster@staff.kuonet-ng.org PART #test
	# :AnMaster!AnMaster@staff.kuonet-ng.org PART #test :with a reason
	Called when someone parts a channel the bot is in
	$1 = who did it (n!u@h)
	$2 = what channel
	$3 = a reason if one exists.
	Return code not checked.
		Reason: A module with a list of users could get desynced if it didn't
		get the part.


module_modulename_on_KICK
	# :AnMaster!AnMaster@staff.kuonet-ng.org KICK #test AnMaster_test :this is a test
	# :AnMaster!AnMaster@staff.kuonet-ng.org KICK #test bashbot :another test
	Called when someone parts a channel the bot is in
	$1 = Who did it (n!u@h).
	$2 = What channel.
	$3 = Who got kicked.
	$4 = A reason if one exists.
	Return code not checked.
		Reason: A module with a list of users could get desynced if it didn't
		get the kick.


module_modulename_on_QUIT
	# :AnMaster_test!AnMaster@staff.kuonet-ng.org QUIT :Quit: ERC Version 5.2 (IRC client for Emacs)
	Called when someone quits
	$1 = Who did it (n!u@h).
	$2 = A reason if one exists.
	Return code not checked.
		Reason: A module with a list of users could get desynced if it didn't
		get the quit.


module_modulename_on_TOPIC
	# :AnMaster!AnMaster@staff.kuonet-ng.org TOPIC #test :Bash bot testing channel
	Called when a topic is set or on channel join
	$1 = Who did it (n!u@h).
	$2 = What channel.
	$3 = New topic.
	Return code not checked.
		Reason: We don't want to get desynced modules.


module_modulename_on_channel_MODE
	# :ChanServ!ChanServ@services.kuonet-ng.org MODE #test +o AnMaster
	# :AnMaster!AnMaster@staff.kuonet-ng.org MODE #test +sk 5
	# :ChanServ!ChanServ@services.kuonet-ng.org MODE #test +nt-k 5
	# :AnMaster!AnMaster@staff.kuonet-ng.org MODE #test -s
	Called when someone changes a mode in the channel
	$1 = Who did it (n!u@h).
	$2 = On what channel.
	$3 = The mode change with it's parameters.
	Return code not checked.
		Reason: A module with a list of users could get desynced if it didn't
		get the mode change.


module_modulename_on_numeric
	Called on any numeric after connect.
	$1 = The numeric.
	$2 = It's data.
	Return code:
		0 = pass it on to next module
		1 = I have taken care of this, and don't
		    consult other modules about this.
	Note: In most cases you DON'T want to return 1 for this. If you do be very very careful.


module_modulename_on_server_ERROR
	# ERROR :Closing link (rfc3092@1.2.3.4) [Killed (AnMaster (testing a kill on inspircd))]
	# ERROR :Closing Link: [1.2.3.4] (Throttled: Reconnecting too fast) -Email staff@kuonet.org for more information.
	# ERROR :Closing Link: bashbot[host.name.se] Brain ([hurricane.KuoNET.org] Local kill by Brain (testing kill on unrealircd))
	# ERROR :Closing Link: bashbot[host.name.se] hurricane.KuoNET.org (Killed (Brain (testing kill on unrealircd, remote one)))
	Called when the bot get an ERROR from the server.
	$1 = The ERROR message.
	Return code not checked.
		Reason: There isn't much point in swallowing this.

module_modulename_on_KILL
	# :AnMaster!AnMaster@staff.kuonet-ng.org KILL bashbot :photon.kuonet-ng.org!staff.kuonet-ng.org!AnMaster (killing to test on inspircd)
	# :Brain!brain@staff.kuonet.org KILL bashbot :staff.kuonet.org!Brain (testing kill on unrealircd)
	# :Brain!brain@staff.kuonet.org KILL bashbot :hurricane!staff.kuonet.org!Brain (testing kill on unrealircd, remote one)
	Called when the bot get a KILL message from the server.
	$1 = The sender of the kill.
	$2 = The target of the kill.
	$3 = The KILL path.
	$4 = The reason.

module_modulename_before_disconnect
	Called when the bot is about to disconnect from server.
	The bot may or may not reconnect after this depending on what caused this.
	Note that this won't be called if the disconnect wasn't planned, like
	a ping timeout, getting killed, and so on.
	the disconnect.
	No parameters.
	Return code not checked.


module_modulename_after_disconnect
	Called when the bot gets disconnected from server.
	The bot may or may not reconnect after this depending on what caused
	the disconnect.
	No parameters.
	Return code not checked.
		Reason: A module may need clean up, don't let it desync.


module_modulename_on_RAW
	Called when the bot gets *ANY* line from the server after the initial connect.
	With this a module can hook onto something not supported by a more specific hook.
	The downsides:
	* Potentially speed as it has to be called for any message.
	* You have to parse more on your own.
	* You can desync other modules! Imagine a module that keep a list of
	  users in the channel. If you swallow a message about a join, part,
	  quit, nickchange, or other ones it may get desynced!
	* Even worse, you can desync the bot itself if you swallow NICK, JOIN
	  PART, KICK or possibly others. Or make it ping out by swallowing PING.
	Parameters:
		$1 = The raw line
	Return code:
		0 = pass it on to next module
		1 = I have taken care of this, and don't
		    consult other modules about this.
		    For raw this means no normal hooks
		    will be called on the line either.
